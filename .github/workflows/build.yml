name: OrangeFox Recovery Build (tapas)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Alan Temizliği ve Hazırlık
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/lib/jvm
          sudo apt-get update
          sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5-dev libssl-dev imagemagick python3 git-core wget

      - name: Kaynakları ve Cihaz Ağacını Hazırla
        run: |
          mkdir ~/fox
          cd ~/fox
          git clone --depth 1 https://gitlab.com/OrangeFox/misc/scripts.git -b master
          cd scripts
          sudo bash setup/android_build_env.sh || true
          cd ..
          mkdir -p device/xiaomi/tapas
          # Bir önceki adımda yeşil alan başarılı yöntemimizi buraya sabitliyoruz
          git clone --depth 1 https://github.com/OrangeFoxRecovery/android_device_xiaomi_tapas.git -b fox_12.1 device/xiaomi/tapas || echo "Dosyalar zaten var."

      - name: ORANGEFOX DERLEMESİNİ BAŞLAT (Final)
        run: |
          cd ~/fox
          # Çevresel değişkenleri yükle
          source build/envsetup.sh
          # Cihazı seç (tapas)
          lunch omni_tapas-eng || lunch fox_tapas-eng
          # Derlemeyi başlat (Bu adım 30-60 dk sürebilir)
          mka recoveryimage -j$(nproc)

      - name: Sonucu Dışarı Aktar (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-Tapas-Recovery
          path: ~/fox/out/target/product/tapas/*.img
